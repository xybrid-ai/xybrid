name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # NDK version - r26b is stable and widely supported
  NDK_VERSION: "26.1.10909125"
  FLUTTER_VERSION: "3.35.7"
  FRB_VERSION: "2.11.1"

permissions:
  contents: write

jobs:
  #
  # Version check - verify all package versions match the git tag
  #
  check-version:
    name: Verify Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check versions match git tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Git tag version: $TAG_VERSION"

          # Check Cargo workspace
          CARGO_VERSION=$(grep -A5 '\[workspace\.package\]' Cargo.toml | grep '^version' | head -1 | sed 's/.*= *"\(.*\)"/\1/')
          echo "Cargo workspace:  $CARGO_VERSION"

          # Check Flutter
          FLUTTER_VERSION_PKG=$(grep '^version:' bindings/flutter/pubspec.yaml | sed 's/version: *//')
          echo "Flutter pubspec:  $FLUTTER_VERSION_PKG"

          # Check Unity
          UNITY_VERSION=$(python3 -c "import json; print(json.load(open('bindings/unity/package.json'))['version'])")
          echo "Unity package:    $UNITY_VERSION"

          # Check Kotlin
          KOTLIN_VERSION=$(grep '^version = ' bindings/kotlin/build.gradle.kts | sed 's/version = "\(.*\)"/\1/')
          echo "Kotlin gradle:    $KOTLIN_VERSION"

          # Verify all match
          FAILED=0
          for V in "$CARGO_VERSION" "$FLUTTER_VERSION_PKG" "$UNITY_VERSION" "$KOTLIN_VERSION"; do
            if [ "$V" != "$TAG_VERSION" ]; then
              echo ""
              echo "ERROR: Version mismatch! Tag is v$TAG_VERSION but found $V"
              echo "Run 'just bump-version $TAG_VERSION' and commit before tagging."
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
          echo ""
          echo "All versions match v$TAG_VERSION"

  #
  # Apple XCFramework build (macOS only)
  #
  build-apple:
    name: Build Apple XCFramework
    needs: [check-version]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: >-
            aarch64-apple-ios,
            aarch64-apple-ios-sim,
            x86_64-apple-ios,
            aarch64-apple-darwin,
            x86_64-apple-darwin

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache environment
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: release-apple

      - name: Build XCFramework
        run: cargo xtask build-xcframework --release

      - name: Prepare artifact with version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist
          cd bindings/apple/XCFrameworks
          zip -r ../../../dist/XybridFFI-${VERSION}.xcframework.zip XybridFFI.xcframework

      - name: Upload XCFramework artifact
        uses: actions/upload-artifact@v4
        with:
          name: xcframework
          path: dist/XybridFFI-*.xcframework.zip
          if-no-files-found: error

  #
  # Android .so files build (Linux with NDK)
  #
  build-android:
    name: Build Android
    needs: [check-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: >-
            aarch64-linux-android,
            armv7-linux-androideabi,
            x86_64-linux-android

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache environment
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: release-android

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --install "ndk;${{ env.NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Android .so files
        run: cargo xtask build-android --release

      - name: Prepare artifact with version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist
          cd bindings/kotlin/libs
          zip -r ../../../dist/xybrid-android-${VERSION}.zip .

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-libs
          path: dist/xybrid-android-*.zip
          if-no-files-found: error

  #
  # Flutter native libraries build (matrix for multiple platforms)
  #
  build-flutter:
    name: Build Flutter (${{ matrix.platform }})
    needs: [check-version]
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
            rust_targets: x86_64-unknown-linux-gnu
          - platform: macos
            os: macos-14
            rust_targets: aarch64-apple-darwin,x86_64-apple-darwin
          - platform: windows
            os: windows-latest
            rust_targets: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache environment
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: release-flutter-${{ matrix.platform }}

      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install LLVM (Linux)
        if: matrix.platform == 'linux'
        run: sudo apt-get update && sudo apt-get install -y llvm-dev libclang-dev clang

      - name: Install LLVM (macOS)
        if: matrix.platform == 'macos'
        run: brew install llvm

      - name: Install LLVM (Windows)
        if: matrix.platform == 'windows'
        run: choco install llvm

      - name: Cache FRB codegen binary
        id: cache-frb
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/flutter_rust_bridge_codegen
            ~/.cargo/bin/flutter_rust_bridge_codegen.exe
          key: frb-codegen-${{ runner.os }}-${{ env.FRB_VERSION }}

      - name: Install flutter_rust_bridge_codegen
        if: steps.cache-frb.outputs.cache-hit != 'true'
        run: cargo install flutter_rust_bridge_codegen@${{ env.FRB_VERSION }}

      - name: Run FRB codegen
        working-directory: bindings/flutter
        run: flutter_rust_bridge_codegen generate

      - name: Check FRB bindings are up-to-date
        run: |
          if ! git diff --exit-code bindings/flutter/lib/src/rust/; then
            echo ""
            echo "ERROR: Flutter Rust Bridge bindings are out of date."
            echo "A Rust API change was committed without regenerating Dart bindings."
            echo ""
            echo "Fix: run 'flutter_rust_bridge_codegen generate' in bindings/flutter/ and commit the result."
            exit 1
          fi
          echo "FRB bindings are up-to-date."

      - name: Force dynamic CRT on Windows (required for cdylib DLL linking)
        if: matrix.platform == 'windows'
        shell: bash
        run: |
          echo "CFLAGS=/MD" >> $GITHUB_ENV
          echo "CXXFLAGS=/MD" >> $GITHUB_ENV

      - name: Build Flutter native library
        run: cargo xtask build-flutter --platform ${{ matrix.platform }} --release --skip-frb-codegen

      - name: Prepare artifact with version (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist
          # Find and package the native library
          if [ -d "bindings/flutter/rust/target" ]; then
            cd bindings/flutter/rust/target
          else
            cd target
          fi
          find . -name "*xybrid_flutter_ffi*" -type f | head -20 | tar -czvf ../../../../dist/xybrid-flutter-${{ matrix.platform }}-${VERSION}.tar.gz -T -

      - name: Prepare artifact with version (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF -replace 'refs/tags/', ''
          New-Item -ItemType Directory -Force -Path dist
          $files = Get-ChildItem -Path . -Recurse -Filter "*xybrid_flutter_ffi*" -File | Select-Object -First 20
          if ($files) {
            Compress-Archive -Path $files.FullName -DestinationPath "dist/xybrid-flutter-windows-$version.zip"
          }

      - name: Upload Flutter artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-${{ matrix.platform }}
          path: dist/xybrid-flutter-*
          if-no-files-found: warn

  #
  # Flutter precompiled binaries (uploaded to separate precompiled_<hash> release)
  # These are auto-downloaded by cargokit when users don't have Rust installed
  #
  precompile-flutter:
    name: Precompile Flutter (${{ matrix.name }})
    needs: [check-version]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: darwin
            os: macos-14
            # buildableTargets() on macOS auto-detects all Darwin targets:
            # aarch64-apple-darwin, x86_64-apple-darwin,
            # aarch64-apple-ios, aarch64-apple-ios-sim, x86_64-apple-ios
            rust_targets: >-
              aarch64-apple-darwin,
              x86_64-apple-darwin,
              aarch64-apple-ios,
              aarch64-apple-ios-sim,
              x86_64-apple-ios
            android: false

          - name: linux
            os: ubuntu-latest
            rust_targets: >-
              x86_64-unknown-linux-gnu,
              aarch64-linux-android,
              armv7-linux-androideabi,
              x86_64-linux-android
            android: true

          - name: windows
            os: windows-latest
            rust_targets: x86_64-pc-windows-msvc
            android: false

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache environment
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: precompile-flutter-${{ matrix.name }}

      - uses: dart-lang/setup-dart@v1

      - name: Install LLVM (Linux)
        if: matrix.name == 'linux'
        run: sudo apt-get update && sudo apt-get install -y llvm-dev libclang-dev clang

      - name: Install LLVM (macOS)
        if: matrix.name == 'darwin'
        run: brew install llvm

      - name: Install LLVM (Windows)
        if: matrix.name == 'windows'
        run: choco install llvm

      - name: Setup Android SDK
        if: matrix.android
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        if: matrix.android
        run: |
          sdkmanager --install "ndk;${{ env.NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Install cargo-ndk
        if: matrix.android
        run: cargo install cargo-ndk

      - name: Install build tool dependencies
        working-directory: bindings/flutter/cargokit/build_tool
        run: dart pub get

      - name: Force dynamic CRT on Windows (required for cdylib DLL linking)
        if: matrix.name == 'windows'
        shell: bash
        run: |
          echo "CFLAGS=/MD" >> $GITHUB_ENV
          echo "CXXFLAGS=/MD" >> $GITHUB_ENV

      - name: Precompile and upload binaries
        working-directory: bindings/flutter/cargokit/build_tool
        shell: bash
        env:
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARGS="--repository ${{ github.repository }} --manifest-dir ${{ github.workspace }}/bindings/flutter/rust --verbose"
          if [ "${{ matrix.android }}" = "true" ]; then
            ARGS="$ARGS --android-sdk-location $ANDROID_HOME --android-ndk-version ${{ env.NDK_VERSION }} --android-min-sdk-version 28"
          fi
          dart run bin/build_tool.dart precompile-binaries $ARGS

  #
  # CLI builds (cross-platform matrix)
  #
  build-cli:
    name: Build CLI (${{ matrix.name }})
    needs: [check-version]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macos-arm64
            os: macos-14
            target: aarch64-apple-darwin
            artifact: xybrid
            features: platform-macos

          - name: macos-x86_64
            os: macos-13
            target: x86_64-apple-darwin
            artifact: xybrid
            features: platform-macos

          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: xybrid
            features: platform-desktop

          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: xybrid.exe
            features: platform-desktop

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache environment
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - uses: Swatinem/rust-cache@v2
        with:
          key: release-cli-${{ matrix.name }}

      - name: Build CLI
        run: cargo build --release -p xybrid-cli --target ${{ matrix.target }} --features ${{ matrix.features }}

      - name: Strip binary (Unix)
        if: runner.os != 'Windows'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact }}

      - name: Prepare artifact
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p dist
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp target/${{ matrix.target }}/release/${{ matrix.artifact }} dist/xybrid-${VERSION}-${{ matrix.name }}.exe
          else
            cp target/${{ matrix.target }}/release/${{ matrix.artifact }} dist/xybrid-${VERSION}-${{ matrix.name }}
            chmod +x dist/xybrid-${VERSION}-${{ matrix.name }}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.name }}
          path: dist/*

  #
  # Create GitHub Release after all builds complete
  #
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-apple, build-android, build-flutter, build-cli]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List all artifacts
        run: |
          echo "All release artifacts:"
          find artifacts -type f | sort

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          echo "## What's Changed" > CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md

          if [ -n "$PREV_TAG" ]; then
            git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s" >> CHANGELOG_RELEASE.md
          else
            git log --pretty=format:"- %s" -n 20 >> CHANGELOG_RELEASE.md
          fi

          echo "" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "### Artifacts" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "**Apple (XCFramework)**" >> CHANGELOG_RELEASE.md
          echo "- \`XybridFFI-${CURRENT_TAG}.xcframework.zip\` - iOS + macOS universal framework" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "**Android**" >> CHANGELOG_RELEASE.md
          echo "- \`xybrid-android-${CURRENT_TAG}.zip\` - Native .so files for all ABIs" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "**Flutter**" >> CHANGELOG_RELEASE.md
          echo "- \`xybrid-flutter-linux-${CURRENT_TAG}.tar.gz\` - Linux native library" >> CHANGELOG_RELEASE.md
          echo "- \`xybrid-flutter-macos-${CURRENT_TAG}.tar.gz\` - macOS native library" >> CHANGELOG_RELEASE.md
          echo "- \`xybrid-flutter-windows-${CURRENT_TAG}.zip\` - Windows native library" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "**CLI**" >> CHANGELOG_RELEASE.md
          echo "- Cross-platform binaries for macOS (arm64, x86_64), Linux (x86_64), and Windows (x86_64)" >> CHANGELOG_RELEASE.md
          echo "" >> CHANGELOG_RELEASE.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}" >> CHANGELOG_RELEASE.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          body_path: CHANGELOG_RELEASE.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
