name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --workspace --all-targets -- -D warnings

  # Feature combination checks - ensure platform builds don't break
  check-no-default-features:
    name: check (no-default-features, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-no-default
      - name: Check without default features
        run: cargo check -p xybrid-core --no-default-features

  check-platform-macos:
    name: check (platform-macos, macos-latest)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: macos-platform
      - name: Check platform-macos
        run: cargo check -p xybrid-sdk --features platform-macos

  check-platform-desktop:
    name: check (platform-desktop, ubuntu-latest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: ubuntu-platform-desktop
      - name: Check platform-desktop
        run: cargo check -p xybrid-sdk --features platform-desktop

  clippy-llm:
    name: clippy (llm-llamacpp, macos-latest)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: macos-clippy-llm
      - name: Clippy with llm-llamacpp
        run: cargo clippy -p xybrid-core --features "ort-download,llm-llamacpp" -- -D warnings

  test-llm:
    name: test (llm-llamacpp, macos-latest)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: macos-test-llm
      - name: Test with llm-llamacpp
        run: cargo test -p xybrid-core --features "ort-download,llm-llamacpp" --lib

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 - Full features
          - os: macos-14
            features: ort-download
            # Note: candle-metal and ort-coreml available but skipped for CI speed

          # macOS x86_64
          - os: macos-13
            features: ort-download

          # Linux x86_64
          - os: ubuntu-latest
            features: ort-download

          # Windows x86_64
          - os: windows-latest
            features: ort-download

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.features }}

      - name: Run tests
        run: cargo test --workspace --features ${{ matrix.features }}

  # Build CLI binary to verify it compiles
  build-cli:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            features: platform-macos
          - os: macos-13
            target: x86_64-apple-darwin
            features: platform-macos
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            features: platform-desktop
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            features: platform-desktop

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-cli

      - name: Build CLI
        run: cargo build --release -p xybrid-cli --target ${{ matrix.target }} --features ${{ matrix.features }}

  # Candle feature (optional, macOS only for Metal)
  test-candle:
    name: Test Candle
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: candle
      - name: Test with Candle
        run: cargo test --workspace --features "ort-download,candle"

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [fmt, clippy, check-no-default-features, check-platform-macos, check-platform-desktop, clippy-llm, test-llm, test, build-cli]
    steps:
      - run: echo "All CI checks passed!"
