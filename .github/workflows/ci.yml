name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --workspace --all-targets -- -D warnings

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 - Full features
          - os: macos-14
            features: ort-download
            # Note: candle-metal and ort-coreml available but skipped for CI speed

          # macOS x86_64
          - os: macos-13
            features: ort-download

          # Linux x86_64
          - os: ubuntu-latest
            features: ort-download

          # Windows x86_64
          - os: windows-latest
            features: ort-download

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.features }}

      - name: Run tests
        run: cargo test --workspace --features ${{ matrix.features }}

  # Build CLI binary to verify it compiles
  build-cli:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
          - os: macos-13
            target: x86_64-apple-darwin
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-cli

      - name: Build CLI
        run: cargo build --release -p xybrid-cli --target ${{ matrix.target }}

  # Candle feature (optional, macOS only for Metal)
  test-candle:
    name: Test Candle
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: candle
      - name: Test with Candle
        run: cargo test --workspace --features "ort-download,candle"

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, build-cli]
    steps:
      - run: echo "All CI checks passed!"
