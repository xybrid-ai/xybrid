name: Build Flutter

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  FLUTTER_VERSION: "3.35.7"
  FRB_VERSION: "2.11.1"

jobs:
  build-flutter:
    name: Build Flutter (${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
            rust_targets: x86_64-unknown-linux-gnu
          - platform: macos
            os: macos-14
            rust_targets: aarch64-apple-darwin
          - platform: windows
            os: windows-latest
            rust_targets: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_targets }}

      # sccache: caches individual compiler outputs (Rust + C/C++)
      # Uses GitHub Actions cache as backend (no external service needed)
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure sccache environment
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "flutter-${{ matrix.platform }}"
          cache-all-crates: "true"
          save-if: "true"

      # Flutter SDK caching via subosito/flutter-action
      # Expected cache hit rate: ~99% (Flutter version changes rarely)
      # Cache includes: Flutter SDK (~1GB), pub cache
      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install LLVM (Linux)
        if: matrix.platform == 'linux'
        run: sudo apt-get update && sudo apt-get install -y llvm-dev libclang-dev clang

      - name: Install LLVM (macOS)
        if: matrix.platform == 'macos'
        run: brew install llvm

      - name: Install LLVM (Windows)
        if: matrix.platform == 'windows'
        run: choco install llvm

      # Cache the FRB codegen binary to avoid compiling from source every run
      - name: Cache FRB codegen binary
        id: cache-frb
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/flutter_rust_bridge_codegen
            ~/.cargo/bin/flutter_rust_bridge_codegen.exe
          key: frb-codegen-${{ runner.os }}-${{ env.FRB_VERSION }}

      - name: Install flutter_rust_bridge_codegen
        if: steps.cache-frb.outputs.cache-hit != 'true'
        run: cargo install flutter_rust_bridge_codegen@${{ env.FRB_VERSION }}

      - name: Force dynamic CRT on Windows (required for cdylib DLL linking)
        if: matrix.platform == 'windows'
        shell: bash
        run: |
          echo "CFLAGS=/MD" >> $GITHUB_ENV
          echo "CXXFLAGS=/MD" >> $GITHUB_ENV

      - name: Run FRB codegen
        working-directory: bindings/flutter
        run: flutter_rust_bridge_codegen generate

      - name: Check FRB bindings are up-to-date
        run: |
          if ! git diff --exit-code bindings/flutter/lib/src/rust/; then
            echo ""
            echo "ERROR: Flutter Rust Bridge bindings are out of date."
            echo "A Rust API change was committed without regenerating Dart bindings."
            echo ""
            echo "Fix: run 'flutter_rust_bridge_codegen generate' in bindings/flutter/ and commit the result."
            exit 1
          fi
          echo "FRB bindings are up-to-date."

      - name: Build Flutter native library
        run: cargo xtask build-flutter --platform ${{ matrix.platform }} --release --skip-frb-codegen

      - name: Verify build output (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Build output for ${{ matrix.platform }}:"
          find bindings/flutter/rust/target -name "libxybrid_flutter_ffi*" -type f 2>/dev/null || \
          find target -name "libxybrid_flutter_ffi*" -type f 2>/dev/null || \
          echo "Note: Library may have been built to different location"

      - name: Verify build output (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Output "Build output for ${{ matrix.platform }}:"
          Get-ChildItem -Path . -Recurse -Filter "xybrid_flutter_ffi*" -ErrorAction SilentlyContinue | Select-Object FullName

      - name: Upload Flutter native library artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-native-${{ matrix.platform }}
          path: |
            bindings/flutter/rust/target/**/release/*xybrid_flutter_ffi*
            target/**/release/*xybrid_flutter_ffi*
          if-no-files-found: error
