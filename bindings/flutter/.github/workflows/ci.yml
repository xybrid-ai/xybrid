name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  analyze:
    name: Dart Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze --no-fatal-infos

  test:
    name: Dart Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

  build-macos:
    name: Build macOS
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # Clone xybrid core dependency
      - name: Clone xybrid
        run: |
          git clone https://github.com/xybrid-ai/xybrid.git ../xybrid
          # Update path dependencies to relative paths
          sed -i '' 's|path = "../../xybrid/|path = "../../../xybrid/|g' rust/Cargo.toml

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Build example app
        working-directory: example
        run: flutter build macos --debug

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # Clone xybrid core dependency
      - name: Clone xybrid
        run: |
          git clone https://github.com/xybrid-ai/xybrid.git ../xybrid
          # Update path dependencies to relative paths
          sed -i 's|path = "../../xybrid/|path = "../../../xybrid/|g' rust/Cargo.toml

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Build example APK
        working-directory: example
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: flutter build apk --debug

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [analyze, test, build-macos, build-android]
    steps:
      - run: echo "All CI checks passed!"
